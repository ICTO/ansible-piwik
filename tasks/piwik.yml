---
# Install Piwik dependencies
- name: "Install Piwik dependencies"
  action: ${ansible_pkg_mgr} pkg=${item} state=installed update-cache=yes
  with_items: ${piwik.dependencies}
  tags:
    - piwik

# Fetch latest release
- name: "Fetch latest Piwik release"
  action: get_url url=${piwik.zip} dest=${piwik.tmp_dir} mode=0440 owner=root group=root
  register: piwik_release
  tags:
    - piwik

# Create Piwik destination folder
- name: "Create Piwik destination folder"
  action: file path=${piwik.install_dir} owner=${piwik.www_user} group=${piwik.www_group} mode=0755 state=directory
  tags:
    - piwik

# Extract package
- name: "Extract Piwik zipfile"
  action: shell unzip -u ${piwik.tmp_dir}/latest.zip -d ${piwik.install_dir}
  when_changed: ${piwik_release}
  tags:
    - piwik

# Create Piwik temp folders
- name: "Create Piwik temp folders"
  action: file path=${piwik.dest_dir}/${item} owner=${piwik.www_user} group=${piwik.www_group} mode=0755 state=directory
  with_items: ${piwik.dirs}
  tags:
    - piwik

# Add Piwik config
- name: "Add Piwik config"
  action: template src=templates/config.ini.php.j2 dest=${piwik.dest_dir}/config/config.ini.php owner=${piwik.www_user} group=${piwik.www_group} mode=0640
  tags:
    - piwik

# Add Piwik Apache alias
- name: "Add Piwik apache Alias"
  action: template src=templates/piwik.j2 dest=/etc/apache2/conf.d/piwik owner=${piwik.www_user} group=${piwik.www_group} mode=0640
  register: apache_conf
  tags:
    - piwik

# Restart Apache if config changed
- name: "Restart Apache"
  action: service name=apache2 state=restarted
  when_changed: ${apache_conf}
  tags:
    - piwik

# Generate admin API token to use in API requests later on
- name: "Generate API auth token"
  action: shell echo -n ${piwik_settings.superuser}${piwik_settings.password} | md5sum | cut -f 1 -d ' '
  register: auth_token
  tags:
    - piwik


- name: "Check if site is present"
  action: shell bash -c "[ `curl 'http://127.0.0.1/piwik/index.php?module=API&method=SitesManager.getSitesIdFromSiteUrl&url=http://${item.url}&format=JSON&token_auth=${auth_token.stdout}'` == '[]' ] && curl 'http://127.0.0.1/piwik/index.php?module=API&method=SitesManager.addSite&siteName=${item.name}&urls=${item.url}&format=json&token_auth=${auth_token.stdout}'"
  ignore_errors: yes
  with_items: ${piwik.sites}
  tags:
    - piwik
